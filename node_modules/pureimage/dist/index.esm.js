var X=(e=>(e[e.transparent=0]="transparent",e[e.aliceblue=4042850303]="aliceblue",e[e.antiquewhite=4209760255]="antiquewhite",e[e.aqua=16777215]="aqua",e[e.aquamarine=2147472639]="aquamarine",e[e.azure=4043309055]="azure",e[e.beige=4126530815]="beige",e[e.bisque=4293182719]="bisque",e[e.black=255]="black",e[e.blanchedalmond=4293643775]="blanchedalmond",e[e.blue=65535]="blue",e[e.blueviolet=2318131967]="blueviolet",e[e.brown=2771004159]="brown",e[e.burlywood=3736635391]="burlywood",e[e.cadetblue=1604231423]="cadetblue",e[e.chartreuse=2147418367]="chartreuse",e[e.chocolate=3530104575]="chocolate",e[e.coral=4286533887]="coral",e[e.cornflowerblue=1687547391]="cornflowerblue",e[e.cornsilk=4294499583]="cornsilk",e[e.crimson=3692313855]="crimson",e[e.cyan=16777215]="cyan",e[e.darkblue=35839]="darkblue",e[e.darkcyan=9145343]="darkcyan",e[e.darkgoldenrod=3095792639]="darkgoldenrod",e[e.darkgray=2846468607]="darkgray",e[e.darkgreen=6553855]="darkgreen",e[e.darkgrey=2846468607]="darkgrey",e[e.darkkhaki=3182914559]="darkkhaki",e[e.darkmagenta=2332068863]="darkmagenta",e[e.darkolivegreen=1433087999]="darkolivegreen",e[e.darkorange=4287365375]="darkorange",e[e.darkorchid=2570243327]="darkorchid",e[e.darkred=2332033279]="darkred",e[e.darksalmon=3918953215]="darksalmon",e[e.darkseagreen=2411499519]="darkseagreen",e[e.darkslateblue=1211993087]="darkslateblue",e[e.darkslategray=793726975]="darkslategray",e[e.darkslategrey=793726975]="darkslategrey",e[e.darkturquoise=13554175]="darkturquoise",e[e.darkviolet=2483082239]="darkviolet",e[e.deeppink=4279538687]="deeppink",e[e.deepskyblue=12582911]="deepskyblue",e[e.dimgray=1768516095]="dimgray",e[e.dimgrey=1768516095]="dimgrey",e[e.dodgerblue=512819199]="dodgerblue",e[e.firebrick=2988581631]="firebrick",e[e.floralwhite=4294635775]="floralwhite",e[e.forestgreen=579543807]="forestgreen",e[e.fuchsia=4278255615]="fuchsia",e[e.gainsboro=3705462015]="gainsboro",e[e.ghostwhite=4177068031]="ghostwhite",e[e.gold=4292280575]="gold",e[e.goldenrod=3668254975]="goldenrod",e[e.gray=2155905279]="gray",e[e.green=8388863]="green",e[e.greenyellow=2919182335]="greenyellow",e[e.grey=2155905279]="grey",e[e.honeydew=4043305215]="honeydew",e[e.hotpink=4285117695]="hotpink",e[e.indianred=3445382399]="indianred",e[e.indigo=1258324735]="indigo",e[e.ivory=4294963455]="ivory",e[e.khaki=4041641215]="khaki",e[e.lavender=3873897215]="lavender",e[e.lavenderblush=4293981695]="lavenderblush",e[e.lawngreen=2096890111]="lawngreen",e[e.lemonchiffon=4294626815]="lemonchiffon",e[e.lightblue=2916673279]="lightblue",e[e.lightcoral=4034953471]="lightcoral",e[e.lightcyan=3774873599]="lightcyan",e[e.lightgoldenrodyellow=4210742015]="lightgoldenrodyellow",e[e.lightgray=3553874943]="lightgray",e[e.lightgreen=2431553791]="lightgreen",e[e.lightgrey=3553874943]="lightgrey",e[e.lightpink=4290167295]="lightpink",e[e.lightsalmon=4288707327]="lightsalmon",e[e.lightseagreen=548580095]="lightseagreen",e[e.lightskyblue=2278488831]="lightskyblue",e[e.lightslategray=2005441023]="lightslategray",e[e.lightslategrey=2005441023]="lightslategrey",e[e.lightsteelblue=2965692159]="lightsteelblue",e[e.lightyellow=4294959359]="lightyellow",e[e.lime=16711935]="lime",e[e.limegreen=852308735]="limegreen",e[e.linen=4210091775]="linen",e[e.magenta=4278255615]="magenta",e[e.maroon=2147483903]="maroon",e[e.mediumaquamarine=1724754687]="mediumaquamarine",e[e.mediumblue=52735]="mediumblue",e[e.mediumorchid=3126187007]="mediumorchid",e[e.mediumpurple=2473647103]="mediumpurple",e[e.mediumseagreen=1018393087]="mediumseagreen",e[e.mediumslateblue=2070474495]="mediumslateblue",e[e.mediumspringgreen=16423679]="mediumspringgreen",e[e.mediumturquoise=1221709055]="mediumturquoise",e[e.mediumvioletred=3340076543]="mediumvioletred",e[e.midnightblue=421097727]="midnightblue",e[e.mintcream=4127193855]="mintcream",e[e.mistyrose=4293190143]="mistyrose",e[e.moccasin=4293178879]="moccasin",e[e.navajowhite=4292783615]="navajowhite",e[e.navy=33023]="navy",e[e.oldlace=4260751103]="oldlace",e[e.olive=2155872511]="olive",e[e.olivedrab=1804477439]="olivedrab",e[e.orange=4289003775]="orange",e[e.orangered=4282712319]="orangered",e[e.orchid=3664828159]="orchid",e[e.palegoldenrod=4008225535]="palegoldenrod",e[e.palegreen=2566625535]="palegreen",e[e.paleturquoise=2951671551]="paleturquoise",e[e.palevioletred=3681588223]="palevioletred",e[e.papayawhip=4293907967]="papayawhip",e[e.peachpuff=4292524543]="peachpuff",e[e.peru=3448061951]="peru",e[e.pink=4290825215]="pink",e[e.plum=3718307327]="plum",e[e.powderblue=2967529215]="powderblue",e[e.purple=2147516671]="purple",e[e.rebeccapurple=1714657791]="rebeccapurple",e[e.red=4278190335]="red",e[e.rosybrown=3163525119]="rosybrown",e[e.royalblue=1097458175]="royalblue",e[e.saddlebrown=2336560127]="saddlebrown",e[e.salmon=4202722047]="salmon",e[e.sandybrown=4104413439]="sandybrown",e[e.seagreen=780883967]="seagreen",e[e.seashell=4294307583]="seashell",e[e.sienna=2689740287]="sienna",e[e.silver=3233857791]="silver",e[e.skyblue=2278484991]="skyblue",e[e.slateblue=1784335871]="slateblue",e[e.slategray=1887473919]="slategray",e[e.slategrey=1887473919]="slategrey",e[e.snow=4294638335]="snow",e[e.springgreen=16744447]="springgreen",e[e.steelblue=1182971135]="steelblue",e[e.tan=3535047935]="tan",e[e.teal=8421631]="teal",e[e.thistle=3636451583]="thistle",e[e.tomato=4284696575]="tomato",e[e.turquoise=1088475391]="turquoise",e[e.violet=4001558271]="violet",e[e.wheat=4125012991]="wheat",e[e.white=4294967295]="white",e[e.whitesmoke=4126537215]="whitesmoke",e[e.yellow=4294902015]="yellow",e[e.yellowgreen=2597139199]="yellowgreen",e))(X||{});var B=function(s,t,r,n){return(s<<24|t<<16|r<<8|n)>>>0},K=function(s,t){return s>>>8*(3-t)&255},W=function(s){return[K(s,0),K(s,1),K(s,2),K(s,3)]};var Y=function(s){return s>>>0};var k=function(s,...t){let r=s;for(let n=0;n<t.length;n+=1)r=r|t[n];return r>>>0},Q=function(s,...t){let r=s;for(let n=0;n<t.length;n+=1)r=r&t[n];return r>>>0};var _=function(s,t){return s<<t>>>0};function $(s,t,r){return s<t?t:s>r?r:s}var nt=function(s,t,r){return s+(t-s)*r};function J(s){if(!s)return 0;if(s.indexOf("#")===0){if(s.length===4){let t=parseInt(s[1],16),r=t<<4|t,n=parseInt(s[2],16),o=n<<4|n,i=parseInt(s[3],16),a=i<<4|i,f=Y(r<<16|o<<8|a);return f=_(f,8),k(f,255)}else if(s.length===5){let t=parseInt(s[1],16),r=t<<4|t,n=parseInt(s[2],16),o=n<<4|n,i=parseInt(s[3],16),a=i<<4|i,f=parseInt(s[4],16),c=f<<4|f,u=Y(r<<16|o<<8|a);return u=_(u,8),k(u,c)}else if(s.length===7){let t=Y(parseInt(s.substring(1),16));return t=_(t,8),k(t,255)}else if(s.length===9)return Y(parseInt(s.substring(1),16))}if(s.indexOf("rgba")===0){let t=s.trim().substring(4).replace("(","").replace(")","").split(",");return B(parseInt(t[0]),parseInt(t[1]),parseInt(t[2]),Math.floor(parseFloat(t[3])*255))}if(s.indexOf("rgb")===0){let t=s.trim().substring(3).replace("(","").replace(")","").split(",");return B(parseInt(t[0]),parseInt(t[1]),parseInt(t[2]),255)}if(G.call(X,s))return X[s];throw new Error("unknown style format: "+s)}var G=Object.hasOwnProperty;function it(s,t=Uint8Array){let r=s.reduce((i,a)=>i+a.length,0);if(!s.length)return null;let n=new t(r),o=0;for(let i of s)n.set(i,o),o+=i.length;return n}var q=class{constructor(...t){if(t.length===4){this.start={},this.end={},[this.start.x,this.start.y,this.end.x,this.end.y]=t;for(let r in t)if(G.call(t,r)&&typeof t[r]!="number")throw TypeError("When passing 4 arguments, only numbers may be passed")}else if(t.length===2)[this.start,this.end]=t;else throw Error("Please pass either two Point objects, or 4 integers to the constructor")}getLength(){return Math.sqrt(Math.pow(this.start.x-this.end.x,2)+Math.pow(this.start.y-this.end.y,2))}is_invalid(){return!!(Number.isNaN(this.start.x)||Number.isNaN(this.end.x)||Number.isNaN(this.start.y)||Number.isNaN(this.end.y)||this.start.x>Number.MAX_SAFE_INTEGER||this.start.y>Number.MAX_SAFE_INTEGER||this.end.x>Number.MAX_SAFE_INTEGER||this.end.y>Number.MAX_SAFE_INTEGER)}};var x=class s{constructor(t,r){this.x=t;this.y=r}clone(){return new s(this.x,this.y)}distance(t){return Math.sqrt(Math.pow(t.x-this.x,2)+Math.pow(t.y-this.y,2))}add(t){return new s(this.x+t.x,this.y+t.y)}subtract(t){return new s(this.x-t.x,this.y-t.y)}magnitude(){return Math.sqrt(this.dotProduct(this))}dotProduct(t){return this.x*t.x+this.y*t.y}divide(t){return new s(this.x/t,this.y/t)}floor(){return new s(Math.floor(this.x),Math.floor(this.y))}round(){return new s(Math.round(this.x),Math.round(this.y))}unit(){return this.divide(this.magnitude())}rotate(t){return new s(Math.cos(t)*this.x-Math.sin(t)*this.y,Math.sin(t)*this.x+Math.cos(t)*this.y)}scale(t){return new s(this.x*t,this.y*t)}equals(t){return this.x===t.x&&this.y===t.y}},D=s=>Math.PI/180*s;function ot(s){let t=Number.POSITIVE_INFINITY,r=Number.POSITIVE_INFINITY,n=Number.NEGATIVE_INFINITY,o=Number.NEGATIVE_INFINITY;return s.forEach(i=>{t=Math.min(t,i.x),r=Math.min(r,i.y),n=Math.max(n,i.x),o=Math.max(o,i.y)}),new j(t,r,n,o)}var j=class s{constructor(t,r,n,o){this.x1=t;this.y1=r;this.x2=n;this.y2=o}contains(t){return!(t.x<this.x1||t.x>=this.x2||t.y<this.y1||t.y>=this.y2)}intersect(t){let r=Math.max(this.x1,t.x1),n=Math.max(this.y1,t.y1),o=Math.min(this.x2,t.x2),i=Math.min(this.y2,t.y2);return new s(r,n,o,i)}};import*as M from"opentype.js";var F={},O=class{constructor(t,r,n,o,i){this.binary=t,this.family=r,this.weight=n,this.style=o,this.variant=i,this.loaded=!1,this.font=null}_load(t){if(this.loaded){t&&t();return}let r=function(n,o){if(n)throw new Error("Could not load font: "+n);this.loaded=!0,this.font=o,t&&t()}.bind(this);M.load(this.binary,r)}loadSync(){if(this.loaded)return this;try{return this.font=M.loadSync(this.binary),this.loaded=!0,this}catch(t){throw new Error("Could not load font: "+t)}}load(){return this.loadPromise()}loadPromise(){return new Promise((t,r)=>{this._load(()=>t())})}};function qt(s,t,r,n,o){return F[t]=new O(s,t,r,n,o),F[t]}var jt=F;function st(s){return F[s]||(s=Object.keys(F)[0]),F[s]}function tt(s,t,r,n,o,i,a){let f=st(s._font.family);if(!f){console.warn("Font missing",s._font);return}let c=et(s,t);(i==="end"||i==="right")&&(r=r-c.width),i==="center"&&(r=r-c.width/2),a==="top"&&(n=n+c.emHeightAscent),a==="middle"&&(n=n+c.emHeightAscent/2+c.emHeightDescent/2),a==="bottom"&&(n=n+c.emHeightDescent);let u=s._font.size;if(!f.loaded){console.warn("font not loaded yet",s._font);return}let l=f.font.getPath(t,r,n,u);s.beginPath(),l.commands.forEach(function(h){switch(h.type){case"M":s.moveTo(h.x,h.y);break;case"Q":s.quadraticCurveTo(h.x1,h.y1,h.x,h.y);break;case"L":s.lineTo(h.x,h.y);break;case"C":s.bezierCurveTo(h.x1,h.y1,h.x2,h.y2,h.x,h.y);break;case"Z":{s.closePath(),o?s.fill():s.stroke(),s.beginPath();break}}})}function et(s,t){let r=st(s._font.family);if(!r)return console.warn("WARNING. Can't find font family ",s._font),{width:10,emHeightAscent:8,emHeightDescent:2};if(!r.font)return console.warn("WARNING. Can't find font family ",s._font),{width:10,emHeightAscent:8,emHeightDescent:2};let n=s._font.size,o=r.font.stringToGlyphs(t),i=0;return o.forEach(function(a){i+=a.advanceWidth}),{width:i/r.font.unitsPerEm*n,emHeightAscent:r.font.ascender/r.font.unitsPerEm*n,emHeightDescent:r.font.descender/r.font.unitsPerEm*n}}var v=class{constructor(){this.stops=[]}addColorStop(t,r){let n=J(""+r);this.stops.push({t,color:n})}_lerpStops(t){t<0&&(t+=1),t>1&&(t-=1);let r=this.stops.slice().reverse().find(l=>l.t<=t),n=this.stops.find(l=>l.t>t);n||(n=this.stops.at(-1));let o=at(t,r.t,n.t,0,1),i=l=>W(l).map(h=>h/255),a=i(r.color),f=i(n.color),c=a.map((l,h)=>nt(l,f[h],o));return(l=>{let h=l.map(m=>m*255);return B(h[0],h[1],h[2],255)})(c)}},E=class extends v{constructor(r,n,o,i){super();this.start=new x(r,n),this.end=new x(o,i)}colorAt(r,n){let o=new x(r,n),i=this.end.subtract(this.start),a=i.magnitude();i=i.divide(a);let c=o.subtract(this.start).dotProduct(i);return c=$(c/a,0,1),this._lerpStops(c)}},A=class extends v{constructor(r,n,o,i){super();this.start=new x(r,n)}colorAt(r,n){let i=new x(r,n).distance(this.start),a=$(i/10,0,1);return this._lerpStops(a)}};function at(s,t,r,n,o){return(s-t)/(r-t)*(o-n)+n}var C=class extends v{constructor(r,n,o){super();this.angle=r,this.start=new x(n,o)}colorAt(r,n){let o=this.start.subtract(new x(r,n)),i=Math.atan2(o.y,o.x)-this.angle,a=at(i,-Math.PI,Math.PI,0,1);return this._lerpStops(a)}};var ft=[1,0,0,1,0,0],N=class s{constructor(t){this.context=t,this.matrix=[1,0,0,1,0,0],this.stack=[]}getMatrix(){return this.matrix}setMatrix(t){this.matrix=[t[0],t[1],t[2],t[3],t[4],t[5]],this.setTransform()}cloneMatrix(t){return[t[0],t[1],t[2],t[3],t[4],t[5]]}cloneTransform(){let t=new s;return t.setMatrix(this.getMatrix()),t}identity(){this.matrix=ft,this.setTransform()}isIdentity(){for(let t=0;t<this.matrix.length;t++)if(this.matrix[t]!==ft[t])return!1;return!0}fromDomMatrix(t){return[t.a,t.b,t.c,t.d,t.e,t.f]}asDomMatrix(){return{is2D:!0,isIdentity:!1,a:this.matrix[0],b:this.matrix[1],c:this.matrix[2],d:this.matrix[3],e:this.matrix[4]}}multiply(t){let r=this.matrix[0]*t[0]+this.matrix[2]*t[1],n=this.matrix[1]*t[0]+this.matrix[3]*t[1],o=this.matrix[0]*t[2]+this.matrix[2]*t[3],i=this.matrix[1]*t[2]+this.matrix[3]*t[3],a=this.matrix[0]*t[4]+this.matrix[2]*t[5]+this.matrix[4],f=this.matrix[1]*t[4]+this.matrix[3]*t[5]+this.matrix[5];this.matrix[0]=r,this.matrix[1]=n,this.matrix[2]=o,this.matrix[3]=i,this.matrix[4]=a,this.matrix[5]=f,this.setTransform()}invert(){let t=1/(this.matrix[0]*this.matrix[3]-this.matrix[1]*this.matrix[2]),r=this.matrix[3]*t,n=-this.matrix[1]*t,o=-this.matrix[2]*t,i=this.matrix[0]*t,a=t*(this.matrix[2]*this.matrix[5]-this.matrix[3]*this.matrix[4]),f=t*(this.matrix[1]*this.matrix[4]-this.matrix[0]*this.matrix[5]);this.matrix[0]=r,this.matrix[1]=n,this.matrix[2]=o,this.matrix[3]=i,this.matrix[4]=a,this.matrix[5]=f,this.setTransform()}save(){let t=this.cloneMatrix(this.getMatrix());this.stack.push(t),this.context&&this.context.save()}restore(){if(this.stack.length>0){let t=this.stack.pop();this.setMatrix(t)}this.context&&this.context.restore()}setTransform(){this.context}translate(t,r){this.matrix[4]+=this.matrix[0]*t+this.matrix[2]*r,this.matrix[5]+=this.matrix[1]*t+this.matrix[3]*r,this.setTransform()}rotate(t){let r=Math.cos(t),n=Math.sin(t),o=this.matrix[0]*r+this.matrix[2]*n,i=this.matrix[1]*r+this.matrix[3]*n,a=this.matrix[0]*-n+this.matrix[2]*r,f=this.matrix[1]*-n+this.matrix[3]*r;this.matrix[0]=o,this.matrix[1]=i,this.matrix[2]=a,this.matrix[3]=f,this.setTransform()}scale(t,r){this.matrix[0]*=t,this.matrix[1]*=t,this.matrix[2]*=r,this.matrix[3]*=r,this.setTransform()}transformPoint(t){let r=t.x,n=t.y;return new x(r*this.matrix[0]+n*this.matrix[2]+this.matrix[4],r*this.matrix[1]+n*this.matrix[3]+this.matrix[5])}};var R=class{constructor(t){this._bitmap=t,this._fillColor=255,this._strokeColor=255,this._lineWidth=1,this._globalAlpha=1,this._transform=new N,this._font={family:"invalid",size:12},this.textAlign="start",this.textBaseline="alphabetic",this.imageSmoothingEnabled=!0,this._clip=null,this._fillStyle_text="",this._strokeStyle_text="",this.states=[]}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t}get globalAlpha(){return this._globalAlpha}set globalAlpha(t){this._globalAlpha=$(t,0,1)}get font(){return`${this._font.size} ${this._font.family}`}set font(t){let r=t.trim().indexOf(" ");this._font.size=parseInt(t.slice(0,r)),this._font.family=t.slice(r).trim()}get fillStyle(){return this._fillStyle_text}set fillStyle(t){t instanceof v?this._fillColor=t:(this._fillColor=J(t),this._fillStyle_text=t)}get strokeStyle(){return this._strokeStyle_text}set strokeStyle(t){t instanceof v?this._strokeStyle_text=t.toString():(this._strokeColor=J(t),this._strokeStyle_text=t)}createLinearGradient(t,r,n,o){return new E(t,r,n,o)}createRadialGradient(t,r){return new A(t,r)}createConicGradient(t,r,n){return new C(t,r,n)}save(){this.states.push({_clip:this._clip}),this._transform.save()}translate(t,r){this._transform.translate(t,r)}rotate(t){this._transform.rotate(t)}scale(t,r){this._transform.scale(t,r)}transform(...t){let r=[...t];this._transform.multiply(r)}setTransform(...t){if(this._transform.identity(),t[0].is2D){let r=this._transform.fromDomMatrix(t[0]);this._transform.multiply(r)}else this._transform.multiply([...t])}getTransform(){return this._transform.asDomMatrix()}restore(){this._transform.restore();let t=this.states.pop();t&&(this._clip=t._clip)}fillRect(t,r,n,o){if(this._transform.isIdentity())for(let i=t;i<t+n;i++)for(let a=r;a<r+o;a++)this.fillPixelWithColor(i,a,this.calculateRGBA(i,a));else{let i=this.path,a=this._closed;this.beginPath(),this.rect(t-1e-4,r-1e-4,n,o),this.closePath(),this.fill(),this.path=i,this._closed=a}}clearRect(t,r,n,o){for(let i=t;i<t+n;i++)for(let a=r;a<r+o;a++)this._bitmap._isValidCoords(t,r)&&this._bitmap.setPixelRGBA(i,a,0)}strokeRect(t,r,n,o){for(let i=t;i<t+n;i++)this.fillPixelWithColor(i,r,this.calculateRGBA_stroke(i,r)),this.fillPixelWithColor(i,r+o,this.calculateRGBA_stroke(i,r+o));for(let i=r;i<r+o;i++)this.fillPixelWithColor(t,i,this.calculateRGBA_stroke(t,i)),this.fillPixelWithColor(t+n,i,this.calculateRGBA_stroke(t+n,i))}strokePixel(t,r){if(!this.pixelInsideClip(t,r))return;let n=this.calculateRGBA_stroke(t,r),o=this._bitmap.getPixelRGBA(t,r),i=this.composite(o,n);this._bitmap.setPixelRGBA(t,r,i)}fillPixelWithColor(t,r,n){if(!this.pixelInsideClip(t,r)||!this._bitmap._isValidCoords(t,r))return;let o=n,i=this._bitmap.getPixelRGBA(t,r),a=this.composite(i,o);this._bitmap.setPixelRGBA(t,r,a)}composite(t,r){let n=W(t),o=W(r),i=o.map(l=>l/255),a=n.map(l=>l/255);i[3]=i[3]*this._globalAlpha;function f(l,h,m,d){return(l*m+h*d*(1-m))/(m+d*(1-m))}let u=i.slice(0,3).map((l,h)=>f(i[h],a[h],i[3],a[3])).map(l=>l*255);return B(u[0],u[1],u[2],Math.max(n[3],o[3]))}calculateRGBA(t,r){return this._fillColor instanceof v?this._fillColor.colorAt(t,r):this._fillColor}calculateRGBA_stroke(t,r){return this._strokeColor instanceof v?this._strokeColor.colorAt(t,r):this._strokeColor}getImageData(t,r,n,o){return this._bitmap._copySubBitmap(t,r,n,o)}putImageData(t,r,n){this._bitmap._pasteSubBitmap(t,r,n)}drawImage(t,r,n,o,i,a,f,c,u){if(typeof o>"u")return this.drawImage(t,0,0,t.width,t.height,r,n,t.width,t.height);if(typeof a>"u")return this.drawImage(t,0,0,t.width,t.height,r,n,o,i);let l=new j(r,n,r+o,n+i),h=[new x(a,f),new x(a+c,f),new x(a+c,f+u),new x(a,f+u)];h=h.map(b=>this._transform.transformPoint(b));let m=ot(h),d=new j(0,0,this._bitmap.width,this._bitmap.height);m=m.intersect(d);let g=this._transform.cloneTransform();g.invert();function p(b,P,y,w,T){return(b-P)/(y-P)*(T-w)+w}for(let b=m.x1;b<m.x2;b++)for(let P=m.y1;P<m.y2;P++){let y=new x(b,P),w=g.transformPoint(y).round();if(w=new x(p(w.x,a,a+c,r,r+o),p(w.y,f,f+u,n,n+i)),l.contains(w)&&this.pixelInsideClip(y.x,y.y)&&this._bitmap._isValidCoords(y.x,y.y)){let T=t.getPixelRGBA(w.x,w.y),U=this._bitmap.getPixelRGBA(y.x,y.y),V=this.composite(U,T);this._bitmap.setPixelRGBA(y.x,y.y,V)}}}beginPath(){this.path=[],this._closed=!1}moveTo(t,r){return this._moveTo(new x(t,r))}_moveTo(t){t=this._transform.transformPoint(t),this.pathstart=t,this.path.push(["m",t])}lineTo(t,r){return this._lineTo(new x(t,r))}_lineTo(t){this.path.push(["l",this._transform.transformPoint(t)])}quadraticCurveTo(t,r,n,o){let i=this._transform.transformPoint(new x(t,r)),a=this._transform.transformPoint(new x(n,o));this.path.push(["q",i,a])}bezierCurveTo(t,r,n,o,i,a){this._bezierCurveTo(new x(t,r),new x(n,o),new x(i,a))}_bezierCurveTo(t,r,n){t=this._transform.transformPoint(t),r=this._transform.transformPoint(r),n=this._transform.transformPoint(n),this.path.push(["b",t,r,n])}arc(t,r,n,o,i,a){function f(u){let l=t+Math.cos(u)*n,h=r+Math.sin(u)*n;return new x(l,h)}o>i&&(i+=Math.PI*2);let c=Math.PI/16;if(a){let u=i;i=o+Math.PI*2,o=u}this._moveTo(f(o));for(let u=o;u<=i;u+=c)this._lineTo(f(u));this._lineTo(f(i))}arcTo(){throw new Error("arcTo not yet supported")}rect(t,r,n,o){this.moveTo(t,r),this.lineTo(t+n,r),this.lineTo(t+n,r+o),this.lineTo(t,r+o),this.lineTo(t,r)}ellipse(){throw new Error("ellipse not yet supported")}clip(){this._clip=z(this.path)}measureText(t){return et(this,t)}closePath(){this._closed||(this.path.push(["l",this.pathstart]),this._closed=!0)}stroke(){let t=bt(this.path),r=pt(t,this.lineWidth/2),n=z(r),o=this.fillStyle;if(this.fillStyle=this.strokeStyle,this.imageSmoothingEnabled?this.fill_aa(n):this.fill_noaa(n),this.fillStyle=o,this.debug){this.save();let i=this.strokeStyle,a=this.lineWidth;this.strokeStyle="red",this.lineWidth=1,console.log("path is",this.path),z(this.path).forEach(f=>this.drawLine(f)),console.log("flat path is",t),z(t).forEach(f=>this.drawLine(f)),console.log("stroke path is",r),z(r).forEach(f=>this.drawLine(f)),console.log("final lines are",n),this.strokeStyle=i,this.lineWidth=a,this.restore()}}drawLine(t){if(t.is_invalid())return console.error("cannot draw line",t);this.imageSmoothingEnabled?this.drawLine_aa(t):this.drawLine_noaa(t)}drawLine_noaa(t){let r=Math.floor(t.start.x),n=Math.floor(t.start.y),o=Math.floor(t.end.x),i=Math.floor(t.end.y),a=Math.abs(o-r),f=r<o?1:-1,c=Math.abs(i-n),u=n<i?1:-1,l=(a>c?a:-c)/2;for(;this.strokePixel(r,n),!(r===o&&n===i);){let h=l;h>-a&&(l-=c,r+=f),h<c&&(l+=a,n+=u)}}drawLine_aa(t){let r=this._lineWidth,n=Math.floor(t.start.x),o=Math.floor(t.start.y),i=Math.floor(t.end.x),a=Math.floor(t.end.y),f=Math.abs(i-n),c=n<i?1:-1,u=Math.abs(a-o),l=o<a?1:-1,h=f-u,m,d,g,p=f+u===0?1:Math.sqrt(f*f+u*u),b=Q(this.calculateRGBA_stroke(n,o),4294967040),P=Q(this.calculateRGBA_stroke(n,o),255);for(r=(r+1)/2;;){let w=255-~~Math.max(0,255*(Math.abs(h-f+u)/p-r+1)),T=k(b,P*w/255);if(this.fillPixelWithColor(n,o,T),m=h,d=n,2*m>=-f){for(m+=u,g=o;m<p*r&&(a!==g||f>u);m+=f){let V=255-~~Math.max(0,255*(Math.abs(m)/p-r+1)),I=k(b,P*V/255);this.fillPixelWithColor(n,g+=l,I)}if(n===i)break;m=h,h-=u,n+=c}if(2*m<=u){for(m=f-m;m<p*r&&(i!==d||f<u);m+=u){let V=255-~~Math.max(0,255*(Math.abs(m)/p-r+1)),I=k(b,P*V/255);this.fillPixelWithColor(d+=c,o,I)}if(o===a)break;h+=f,o+=l}}}fill(){this._closed||this.closePath();let t=z(this.path);this.imageSmoothingEnabled?this.fill_aa(t):this.fill_noaa(t)}fill_aa(t){let r=ht(t),n=Math.min(r.y2+1,this._bitmap.height),o=Math.max(r.y-1,0);for(let i=n;i>=o;i--){let a=rt(t,i);for(let f=0;f<a.length;f+=2){let c=lt(a[f]),u=lt(a[f+1]),l=Math.floor(a[f]),h=Math.floor(a[f+1]);for(let m=l;m<=h;m++){let d=Q(this.calculateRGBA(m,i),4294967040),g=Q(this.calculateRGBA(m,i),255),p=this.calculateRGBA(m,i);if(m===l){let b=k(d,(1-c)*g);this.fillPixelWithColor(m,i,b);continue}if(m===h){let b=k(d,u*g);this.fillPixelWithColor(m,i,b);continue}this.fillPixelWithColor(m,i,p)}}}}fill_noaa(t){let r=ht(t),n=Math.min(r.y2+1,this._bitmap.height),o=Math.max(r.y-1,0);for(let i=n;i>=o;i--){let a=rt(t,i);for(let f=0;f<a.length;f+=2){let c=Math.floor(a[f]),u=Math.floor(a[f+1]);for(let l=c;l<=u;l++){let h=this.calculateRGBA(l,i);if(l===c){this.fillPixelWithColor(l,i,h);continue}if(l===u){this.fillPixelWithColor(l,i,h);continue}this.fillPixelWithColor(l,i,h)}}}}pixelInsideClip(t,r){return this._clip?rt(this._clip,r).filter(i=>i<t).length%2!==0:!0}fillText(t,r,n){tt(this,t,r,n,!0,this.textAlign,this.textBaseline)}strokeText(t,r,n){tt(this,t,r,n,!1,this.textAlign,this.textBaseline)}};function lt(s){return s-Math.floor(s)}function z(s){let t=[],r=null;return s.forEach(function(n){if(n[0]==="m"&&(r=n[1]),n[0]==="l"){let o=n[1];t.push(new q(r,o)),r=o}if(n[0]==="q"){let o=[r,n[1],n[2]];for(let i=0;i<1;i+=.1){let a=yt(o,i);t.push(new q(r,a)),r=a}}if(n[0]==="b"){let o=[r,n[1],n[2],n[3]];ut(o,10).forEach(i=>{t.push(new q(r,i)),r=i})}}),t}function bt(s){let t=[],r=null;return s.forEach(n=>{if(n[0]==="m"){r=n[1],t.push(["m",new x(r.x,r.y)]);return}if(n[0]==="l"){r=n[1],t.push(["l",new x(r.x,r.y)]);return}if(n[0]==="b"){let o=[r,n[1],n[2],n[3]],i=ut(o,10);for(let a=1;a<i.length;a+=2)t.push(["l",new x(i[a].x,i[a].y)]);r=n[3]}}),t}function pt(s,t){let r=[],n=[];s.forEach(a=>{a[0]==="m"&&(n.length>0&&r.push(n),n=[]),n.push(a)}),n.length>0&&r.push(n),r.forEach(a=>{a[0][0]!=="m"&&console.warn("missing a starting move command!")});let o=r.map(a=>gt(a,t)),i=[];return o.forEach(a=>a.forEach(f=>i.push(f))),i}function gt(s,t){let r=null,n=[],o=[],i=null;function a(l,h,m){l.equals(h)&&console.log("same points!",l,h);let d=l.subtract(h).unit(),g=d.rotate(D(90)),p=d.rotate(D(-90));return[g.scale(m).add(h),p.scale(m).add(h)]}let f=null;function c(l){return l<-Math.PI?l+Math.PI*2:l>+Math.PI?l-Math.PI*2:l}s.forEach(function(l,h){if(l[0]==="m"&&(r=l[1],f=l,i=r.clone(),n.push(["m",i.clone()])),l[0]==="l"){let m=r,d=l[1];if(m.equals(d))return console.log("can't project the same paths",h,l,m,d);let g=s[h+1];if(f[0]==="m"){let I=a(d,m,t);n.push(["l",I[1]]),o.push(["l",I[0]])}if(f=l,!g){let I=a(m,d,t);n.push(["l",I[0]]),o.push(["l",I[1]]);return}let p=g[1];if(p.equals(d))return console.log("can't project the same paths",h,l,m,d);let b=m.subtract(d),P=p.subtract(d),y=Math.atan2(b.y,b.x),w=Math.atan2(P.y,P.x),T=c(w-y),U=a(m,d,t),V=a(p,d,t);if(T<0){n.push(["l",U[0]]),n.push(["l",V[1]]);let I=t/Math.cos((Math.PI+T)/2),L=m.subtract(d).unit().rotate(T/2).scale(I).add(d);o.push(["l",L])}else{let I=t/Math.cos(-(Math.PI-T)/2),L=p.subtract(d).unit().rotate(-T/2).scale(I).add(d);n.push(["l",L]),o.push(["l",U[1]]),o.push(["l",V[0]])}r=d}}),o.reverse();let u=[].concat(n).concat(o);return u.push(["l",i]),u}function yt(s,t){let r=(1-t)*(1-t)*s[0].x+2*(1-t)*t*s[1].x+t*t*s[2].x,n=(1-t)*(1-t)*s[0].y+2*(1-t)*t*s[1].y+t*t*s[2].y;return new x(r,n)}function ut(s,t){function r(n){if(wt(n)<t)return[n[0],n[3]];let o=Pt(n,.5);return r(o[0]).concat(r(o[1]))}return r(s)}function Pt(s,t){let r=s[0],n=s[1],o=s[2],i=s[3],a=Z(r,n,t),f=Z(n,o,t),c=Z(i,o,t),u=Z(a,f,t),l=Z(f,c,t),h={x:(l.x-u.x)*t+u.x,y:(l.y-u.y)*t+u.y};return[[r,a,u,h],[h,l,c,i]]}function wt(s){let t=s[0],r=s[1],n=s[2],o=s[3],i=Math.pow(3*r.x-2*t.x-o.x,2),a=Math.pow(3*r.y-2*t.y-o.y,2),f=Math.pow(3*n.x-2*o.x-t.x,2),c=Math.pow(3*n.y-2*o.y-t.y,2);return i<f&&(i=f),a<c&&(a=c),i+a}function Z(s,t,r){return{x:(t.x-s.x)*r+s.x,y:(t.y-s.y)*r+s.y}}function ht(s){let t={x:Number.MAX_VALUE,y:Number.MAX_VALUE,x2:Number.MIN_VALUE,y2:Number.MIN_VALUE};function r(n){t.x=Math.min(t.x,n.x),t.y=Math.min(t.y,n.y),t.x2=Math.max(t.x2,n.x),t.y2=Math.max(t.y2,n.y)}return s.forEach(function(n){r(n.start),r(n.end)}),t}function rt(s,t){let r=[];for(let n=0;n<s.length;n++){let o=s[n].start,i=s[n].end;if(o.y<t&&i.y>=t||i.y<t&&o.y>=t){let a=o.x+(t-o.y)/(i.y-o.y)*(i.x-o.x);r.push(a)}}return r.sort(function(n,o){return n-o})}var H=class s{constructor(t,r){this.width=Math.floor(t),this.height=Math.floor(r),this.data=new Uint8Array(t*r*4);let n=255;for(let o=0;o<r;o++)for(let i=0;i<t;i++)this.setPixelRGBA(i,o,n);this._context=new R(this)}calculateIndex(t,r){return t=Math.floor(t),r=Math.floor(r),t<0||r<0||t>=this.width||r>=this.height?0:(this.width*r+t)*4}setPixelRGBA(t,r,n){this.validate_coords(t,r);let o=this.calculateIndex(t,r),i=W(n);this.data[o+0]=i[0],this.data[o+1]=i[1],this.data[o+2]=i[2],this.data[o+3]=i[3]}setPixelRGBA_i(t,r,n,o,i,a){let f=this.calculateIndex(t,r);this.data[f+0]=n,this.data[f+1]=o,this.data[f+2]=i,this.data[f+3]=a}getPixelRGBA(t,r){this.validate_coords(t,r);let n=this.calculateIndex(t,r);return B(this.data[n+0],this.data[n+1],this.data[n+2],this.data[n+3])}getDebugPixelRGBA(t,r){let n=this.calculateIndex(t,r),o=this.width,i=this.height,a=this.data;return console.dir({i:n,width:o,height:i,data:a}),B(this.data[n+0],this.data[n+1],this.data[n+2],this.data[n+3])}getPixelRGBA_separate(t,r){let n=this.calculateIndex(t,r);return this.data.slice(n,n+4)}getContext(t){return t==="2d"?this._context:null}_copySubBitmap(t,r,n,o){let i=new s(n,o);for(let a=0;a<n;a++)for(let f=0;f<o;f++){let c=this.calculateIndex(t+a,r+f),u=i.calculateIndex(a,f);for(let l=0;l<4;l++)i.data[u+l]=this.data[c+l]}return i}_pasteSubBitmap(t,r,n){for(let o=0;o<t.width;o++)for(let i=0;i<t.height;i++){let a=this.calculateIndex(r+o,n+i),f=t.calculateIndex(o,i);for(let c=0;c<4;c++)this.data[a+c]=t.data[f+c]}}_isValidCoords(t,r){return!(t<0||r<0||t>=this.width||r>=this.height)}validate_coords(t,r){if(t<0)throw new Error(`Invalid Index: x ${t} <0`);if(r<0)throw new Error(`Invalid Index: y ${r} <0`);if(t>=this.width)throw new Error(`Invalid Index: x ${t} >= width ${this.width}`);if(r>=this.height)throw new Error(`Invalid Index: y ${r} >= height ${this.height}`)}};import*as Tt from"pngjs";import*as S from"jpeg-js";var{PNG:ct}=Tt;function he(s,t){return new H(s,t)}function ue(s,t,r={}){return new Promise((n,o)=>{if(!G.call(s,"data")||!G.call(s,"width")||!G.call(s,"height"))return o(new TypeError("Invalid bitmap image provided"));let i=new ct({width:s.width,height:s.height,deflateLevel:r.deflateLevel||9,deflateStrategy:r.deflateStrategy||3});for(let a=0;a<s.width;a++)for(let f=0;f<s.height;f++){let c=s.getPixelRGBA(a,f),u=(f*s.width+a)*4,l=W(c);for(let h=0;h<4;h++)i.data[u+h]=l[h]}i.on("error",a=>{o(a)}).pack().pipe(t).on("finish",()=>{n()}).on("error",a=>{o(a)})})}function ce(s){return new Promise((t,r)=>{s.pipe(new ct).on("parsed",function(){let n=new H(this.width,this.height);for(let o=0;o<n.data.length;o++)n.data[o]=this.data[o];t(n)}).on("error",function(n){r(n)})})}function me(s,t,r=90){return new Promise((n,o)=>{if(!G.call(s,"data")||!G.call(s,"width")||!G.call(s,"height"))return o(new TypeError("Invalid bitmap image provided"));let i={data:s.data,width:s.width,height:s.height};t.on("error",a=>o(a)),t.write(S.encode(i,r).data,()=>{t.end(),n()})})}function xe(s,t){return new Promise((r,n)=>{try{let o=[];s.on("data",i=>o.push(i)),s.on("end",()=>{let i=it(o),a=null;try{a=S.decode(i,t)}catch(c){n(c);return}let f=new H(a.width,a.height);for(let c=0;c<a.width;c++)for(let u=0;u<a.height;u++){let l=(u*a.width+c)*4;f.setPixelRGBA_i(c,u,a.data[l+0],a.data[l+1],a.data[l+2],a.data[l+3])}r(f)}),s.on("error",i=>{n(i)})}catch(o){console.log(o),n(o)}})}export{H as Bitmap,R as Context,jt as debug_list_of_fonts,xe as decodeJPEGFromStream,ce as decodePNGFromStream,me as encodeJPEGToStream,ue as encodePNGToStream,he as make,et as measureText,tt as processTextPath,qt as registerFont};
